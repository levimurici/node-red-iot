"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.getCurrentVersion = exports.migrate = void 0;
const migrations_1 = __importDefault(require("../nodes/api/migrations"));
const migrations_2 = __importDefault(require("../nodes/call-service/migrations"));
const migrations_3 = __importDefault(require("../nodes/config-server/migrations"));
const migrations_4 = __importDefault(require("../nodes/current-state/migrations"));
const migrations_5 = __importDefault(require("../nodes/device/migrations"));
const migrations_6 = __importDefault(require("../nodes/entity/migrations"));
const migrations_7 = __importDefault(require("../nodes/events-all/migrations"));
const migrations_8 = __importDefault(require("../nodes/events-state/migrations"));
const migrations_9 = __importDefault(require("../nodes/fire-event/migrations"));
const migrations_10 = __importDefault(require("../nodes/get-entities/migrations"));
const migrations_11 = __importDefault(require("../nodes/get-history/migrations"));
const migrations_12 = __importDefault(require("../nodes/poll-state/migrations"));
const migrations_13 = __importDefault(require("../nodes/render-template/migrations"));
const migrations_14 = __importDefault(require("../nodes/tag/migrations"));
const migrations_15 = __importDefault(require("../nodes/time/migrations"));
const migrations_16 = __importDefault(require("../nodes/trigger-state/migrations"));
const migrations_17 = __importDefault(require("../nodes/wait-until/migrations"));
const migrations_18 = __importDefault(require("../nodes/webhook/migrations"));
const migrations_19 = __importDefault(require("../nodes/zone/migrations"));
const nodeTypeTranslation = {
    'ha-api': migrations_1.default,
    'api-call-service': migrations_2.default,
    server: migrations_3.default,
    'api-current-state': migrations_4.default,
    'ha-device': migrations_5.default,
    'ha-entity': migrations_6.default,
    'server-events': migrations_7.default,
    'server-state-changed': migrations_8.default,
    'ha-fire-event': migrations_9.default,
    'ha-get-entities': migrations_10.default,
    'api-get-history': migrations_11.default,
    'poll-state': migrations_12.default,
    'api-render-template': migrations_13.default,
    'trigger-state': migrations_16.default,
    'ha-tag': migrations_14.default,
    'ha-time': migrations_15.default,
    'ha-wait-until': migrations_17.default,
    'ha-webhook': migrations_18.default,
    'ha-zone': migrations_19.default,
};
function migrate(schema) {
    var _a;
    const currentVersion = getCurrentVersion(schema.type);
    if (schema.version !== undefined && schema.version >= currentVersion) {
        return schema;
    }
    const currentMigration = (_a = findMigration(schema.type, schema.version)) === null || _a === void 0 ? void 0 : _a.up;
    if (currentMigration) {
        const newSchema = currentMigration(schema);
        return migrate(newSchema);
    }
    return schema;
}
exports.migrate = migrate;
function findMigration(nodeType, version = -1) {
    const migrations = getMigrationsByType(nodeType);
    const migration = migrations.find((m) => m.version === Number(version) + 1);
    return migration;
}
function getMigrationsByType(nodeType) {
    return nodeTypeTranslation[nodeType];
}
function getCurrentVersion(nodeType) {
    const migrations = getMigrationsByType(nodeType) || [];
    const currentVersion = migrations.reduce((acc, i) => {
        return i.version > acc ? i.version : acc;
    }, 0);
    return currentVersion;
}
exports.getCurrentVersion = getCurrentVersion;
